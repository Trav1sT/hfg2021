{% extends "abcd/stepbase.html" %}

{% load static %}

{% block header_files %}
<style>
body {
  background-color: #4BED93;
}

.img-screen5 {
  position: relative;
  top: 10vh;
  left: 40vw;
  width: 800px;
  z-index: 0;
}

.list-group {
  width: 200px;
}
.list-group-item {
  width: 200px;
}
.sortable {
  min-height: 50px;
  width: inherit;
}
.placeholder {
  background-color:rgba(72, 72, 72, 0.201);
  opacity: 20%;
  list-style: none;
  height: 50px;
  width: 200px;

}


.trash {
  background-color: #ff575748;
  visibility: hidden;
  border-width: 5px!important;
  width: 100%;
}

.main {
  z-index: 100;
  position: absolute;
}
.border-width-5 {
  border-width: 5px!important;
}

.institution-body h3 {
  color: white;
}

small {
  width: inherit;
  overflow-wrap: break-word;
}

</style>>
{% endblock %}


{% block content %}

<div class="main">
<div class="container">
    <h1>What are the institutions and associations involved?</h1>
    <div class="row mt-5">
        <div class="col-6">
            <div class="container">
                <h2>Institutions</h2>
                <div class="container institutions-container">
                </div>
            </div>
        </div>
        <div class="col">
            <div class="container">
                <h2>Stakeholders</h2>
                <ul class="list-group stakeholders-list-group">
                </ul>
            </div>
            <div class="trash container mt-5 m-0 p-1 text-center border rounded"><i>Drop here to remove</i></div>
        </div>
        
    </div>
</div>
</div>
<img src="../../static/abcd/img/step4.png" class="img-screen5"/>

{% endblock %}

{% block js %}

<script>
  $(document).ready(function () {
    initDragDrop();
  });
  
  function initDragDropSets(institutions) {
    return new Array(institutions.length).fill(0).map(()=> new Set());
  }
  
  function initDragDrop() {
    const icolumns = 4;
    const stakeholders = ["Students", "Workers", "Police", "A", "B", "C", "D", "E", "F"];
    const institutions = ["University", "Factory", "Police Headquarters"];
  
    const dragDropSets = initDragDropSets(institutions);
    let removeIntent = false;
  
    $("ul, li").disableSelection();
  
    stakeholders.map((stakeholder, index) => {
      var draggableElement = $("<ul></ul>").text(stakeholder);
      draggableElement.addClass("draggable");
      draggableElement.addClass("list-group-item");
      draggableElement.attr("id", `stakeholders-${index}`);
      draggableElement.attr("data", index);
  
      draggableElement.draggable({
        connectToSortable: ".sortable",
        helper: "clone",
        opacity: 0.5,
        revert: "invalid",
        start: () => {
          $(".institution-notif").text("Drop unique stakeholders here");
        },
        stop: () => {
          $(".institution-notif").text("");
        }
      });
      $(".stakeholders-list-group").append(draggableElement);
      
    });
  
    var institutionsContainer = $(".institutions-container");
    var rowNum = 0;
    institutions.map((institution, index) => {
      if (index % icolumns === 0) {
        rowNum++;
        const rowElement = $("<div class='row'></div>");
        rowElement.attr("id", `row-${rowNum}`);
        institutionsContainer.append(rowElement);
      }
      const colElement = $("<div class='col'></div>");
      colElement.addClass("institution-body");
      colElement.addClass(["border", "border-width-5", "border-white", "rounded", "m-2", "p-2"]);
  
      const nameElement = $("<h3></h3>").text(institution);
      const sortableElement = $("<ul></ul>");
      sortableElement.attr("id", `institutions-${index}`);
      sortableElement.attr("data", index);
      sortableElement.addClass("list-group");
      sortableElement.addClass("sortable");
  
      sortableElement.sortable({
        revert: true,
        placeholder: "placeholder"
        
      });
  
      sortableElement.on("sortreceive", function(event, ui) {
        
        var pasteItem = !dragDropSets[$(this).attr("data")].has(ui.item.attr("data"));
  
        if (pasteItem) {
          dragDropSets[index].add(ui.item.attr("data"));
        } else {
          $(this).data().uiSortable.currentItem.remove()
        }
        // AJAX REQUEST HERE
        console.log($(this).children());
        console.log(dragDropSets[index]);
      });
  
      const notifierElement = $("<small></small>");
      notifierElement.addClass("institution-notif");
  
  
      colElement.append(nameElement, sortableElement, notifierElement);
      $(`#row-${rowNum}`).append(colElement);
    });
  
    $(".trash").droppable({
      accept: ".sortable, .draggable",
      activate: function(event, ui) {
        $(this).css("visibility", "visible");
        
      },
      deactivate: function(event, ui) {
        $(this).css("visibility", "hidden");
        
      },
      drop: function(event, ui) {
        ui.helper.remove();
        $(this).css("visibility", "hidden");
        refreshChildrenSetOfInstitutions(institutions, dragDropSets);
      }
  
    });
    
  }
  
  
  function refreshChildrenSetOfInstitutions(institutions, institutionSets) {
  
    institutions.map((val, i) => {
      var children = $(`#institutions-${i}`).children();
      const set = new Set();
      children.each((idx, val) => {
        set.add($(this).attr("data"));
      });
      institutionSets[i] = set;
      console.log(set);
    });
  }
</script>
{% endblock %}